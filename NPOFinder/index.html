<!doctype html>
<!--
name:           Jonathan Klaiber
student nr:     10004077
Programmeer Project Juni 2015
-->
<html lang="en" xml:lang="en">
  <head>
      <title>NPO Geo Finder</title>
      <link rel="stylesheet" type="text/css" href="finder.css"/>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

  </head>
  <body>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places"></script>
    <script src="d3.js"></script>
    
    <script>
      // Constants
      var resp = null;
      var markers = [];
      var listArray = [];



      function initialize() {

        // Constants
        var boundsScaling = 0.00028;


        // var markers = [];
        var map = new google.maps.Map(document.getElementById('map-canvas'), {
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });


        var defaultBounds = new google.maps.LatLngBounds(
            new google.maps.LatLng(51.5, 5),
            new google.maps.LatLng(53.5, 7));
        map.fitBounds(defaultBounds);



        // Create the search box and link it to the UI element.
        var input = /** @type {HTMLInputElement} */(
            document.getElementById('pac-input'));
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

        var searchBox = new google.maps.places.SearchBox(
          /** @type {HTMLInputElement} */(input));

        // [START region_getplaces]
        // Listen for the event fired when the user selects an item from the
        // pick list. Retrieve the matching places for that item.
        google.maps.event.addListener(searchBox, 'places_changed', function() {
          
          deleteMarkers()
          if(!d3.select("#episodelist").select("ul").empty()) {
            d3.select("#episodelist").select("ul").remove()
          }
          

          var places = searchBox.getPlaces();

          if (places.length == 0) {
            return;
          }
          for (var i = 0, marker; marker = markers[i]; i++) {
            marker.setMap(null);
          }

          // For each place, get the icon, place name, and location.
          markers = [];
          var bounds = new google.maps.LatLngBounds();
          for (var i = 0, place; place = places[i]; i++) {
            var image = {
              url: place.icon,
              size: new google.maps.Size(71, 71),
              origin: new google.maps.Point(0, 0),
              anchor: new google.maps.Point(17, 34),
              scaledSize: new google.maps.Size(25, 25)
            };

            // Create a marker for each place.
            var marker = new google.maps.Marker({
              map: map,
              icon: image,
              title: place.name,
              position: place.geometry.location
            });
            //console.log('place.geometry.location')
            //console.log(place.geometry.location)

            markers.push(marker);


            bounds.extend(place.geometry.location);
       
            bounds.za.A = bounds.za.A * (1 + boundsScaling);
            bounds.za.j = bounds.za.j * (1 - boundsScaling);
            bounds.qa.A = bounds.qa.A * (1 + boundsScaling);
            bounds.qa.j = bounds.qa.j * (1 - boundsScaling);

            var req = createRequest();
            console.log('req')
            console.log(req)
            url1 = 'http://backstage-api.openstate.eu/v0/search'
            url2 = "http://backstage-api.openstate.eu/v0/sources"
            url3 = 'http://backstage-api.openstate.eu/v0/journalistiek/search'
            url4 = 'http://backstage-api.openstate.eu/v0/npo_journalistiek/journalistiek_Oben_290_37227'


            var markerGeo = place.geometry.location;
            var markerName = place.name;


            
            // Create the callback:
            req.onreadystatechange = function() {
              if (req.readyState != 4) return; // Not there yet
              if (req.status != 200) {
                // Handle request failure here...
                return;
              }
              // Request successful, read the response
              resp = req.responseText;
              // ... and use it as needed by your app

              // console.log('resp')
              // console.log(resp)
              var obj = JSON.parse(resp);
              var hits = obj.hits.hits

              // parseDate(hits[i]._source.Date.substring(0,hits[i]._source.Date.indexOf("T")))

              console.log("Number hits")
              console.log(hits.length)
              var markerArray = [];
              var program = null;
              listArray = []
              for (var i = 0; i < hits.length; i++) {

                if(hits[i]._source.Broadcasters != null) {
                    program = hits[i]._source.Broadcasters[0].Name
                }
                // console.log('Hit')
                // console.log(hits[i]._source)

                
                if(hits[i]._source.Locations != null) {

                  var item = new ItemMarker(hits[i]._source.Id,
                                            hits[i]._source.Title,
                                            program,
                                            parseDate(hits[i]._source.Date.replaceAt(10,' ')),
                                            hits[i]._source.Locations[0].Name,
                                            hits[i]._source.Locations[0].GeoPoint.Latitude,
                                            hits[i]._source.Locations[0].GeoPoint.Longitude,
                                            hits[i]._source.Url, 
                                            hits[i]._source.description,
                                            [markerGeo.A, markerGeo.F])
                   markerArray.push(item)


                } else {
                  var item = new ItemMarker(hits[i]._source.Id,
                                            hits[i]._source.Title,
                                            program,
                                            parseDate(hits[i]._source.Date.replaceAt(10,' ')),
                                            markerName,
                                            null,
                                            null,
                                            hits[i]._source.Url, 
                                            hits[i]._source.description,
                                            [markerGeo.A, markerGeo.F])


                  listArray.push(item)
                }
              }
              console.log('marker Length')
              console.log(markerArray.length)
              console.log('list Length')
              console.log(listArray.length)

              if (markerArray.length > 0) {
                for (var i = 0; i < markerArray.length; i++) {
                  placeMarker(map, markerArray[i])
                }
                
              }


              var data = [
                    {"name":"npo", "links":["npo.nl", "nos.nl"]}, 
                    {"name":"ajax", "links":["ajax.nl", "eredivisie.nl", "f"]}
                         ]

              console.log('data print')
              console.log(data)

              var episodelist = d3.select("#episodelist").append("ul");
              episodelist.selectAll("li")
                  .data(listArray.slice(0, 10))
                  .enter()
                  .append("li")
                    .text(function(d){return d.title;})
                    .on("click", expand)
              



            }

            req.onreadystatechange()


            // var arguments = '{"query": "ajax","facets": {"collection": {},"date": {"interval": "day"}},"filters": {"media_content_type": {"terms": ["image/jpeg"]}},"size": 1}';
            // , "filters": {"media_content_type": {"terms": ['video/avi', 'video/mpeg', 'video/quicktime']}}
            // , "sort": "date"
            arguments = '{"query": "' + place.name + '","size": 100, "sort": "date"}';
            // req.open("GET", url2, true);
            // req.send();

            query = 'POST'

            if (query == 'GET') {
              req.open("GET", url4, true);
              req.send();
            } else {
              req.open("POST", url3, true);
              req.setRequestHeader("Content-Type",
                         "application/x-www-form-urlencoded");
              req.send(arguments);
            }



          }
          map.fitBounds(bounds);
        });
        // [END region_getplaces]

        // Bias the SearchBox results towards places that are within the bounds of the
        // current map's viewport.
         // defined above
        google.maps.event.addListener(map, 'bounds_changed', function() {
          var bounds = map.getBounds();


  
          searchBox.setBounds(bounds);
        });
      }

      google.maps.event.addDomListener(window, 'load', initialize);





      function createRequest() {
        var result = null;
        if (window.XMLHttpRequest) {
          // FireFox, Safari, etc.
          result = new XMLHttpRequest();
          if (typeof result.overrideMimeType != 'undefined') {
            result.overrideMimeType('text/xml'); // Or anything else
          }
        }
        else if (window.ActiveXObject) {
          // MSIE
          result = new ActiveXObject("Microsoft.XMLHTTP");
        } 
        else {
          // No known mechanism -- consider aborting the application
        }
        return result;
      }

      // Sets the map on all markers in the array.
      function setAllMap(map) {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
        }
      }

      // Removes the markers from the map, but keeps them in the array.
      function clearMarkers() {
        setAllMap(null);
      }

      // Deletes all markers in the array by removing references to them.
      function deleteMarkers() {
        clearMarkers();
        markers = [];
      }

      function placeList(list, item) {

      }



      function placeMarker(map, item) {
        var googleLatLng = new google.maps.LatLng(item.locationLat, item.locationLong);

        var programArray = ['avro', 'bnn', 'kro', 'kro-ncrv',
                            'max', 'ncrv', 'tros', 'vara',
                            'vpro']

        if (programArray.indexOf(item.program.toLowerCase()) > -1) {
          var icon = 'images/' + item.program.toLowerCase() + '_logo_small.png'
        } else {
          var icon = 'images/npo_journalistiek_logo_small.png' 
        }

        var marker = new google.maps.Marker({
                  position: googleLatLng,
                  map: map,
                  icon: icon,
                  id: item.id
        });
        var contentString = '<div id="content">'+
            '<div id="siteNotice">'+
            '</div>'+
            '<div id="bodyContent">'+
            '<p><b>Title: </b>' + item.title + '<br>' +
            '<b>Date: </b>' + transDate(item.date) + '<br>' +
            '<b>Link: </b> <a href="' + item.link +'" target="_blank">'+
            item.link.substring(item.link.indexOf('//') + 2, item.link.indexOf('.nl') + 3) + '</a> <br> <br>' +
             '<b> Description: </b> <br>' + item.description.substring(item.description.indexOf('<p>'), item.description.indexOf('</p>')) + 
            '</p>'+
            '</div>'+
            '</div>';


        var infowindow = new google.maps.InfoWindow({
            content: contentString,
            maxWidth: 250
          });

        google.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map, marker);
        });
      }





      //console.log('item')
      //console.log(item.list)
      // From http://stackoverflow.com/questions/1431094/how-do-i-replace-a-character-at-a-particular-index-in-javascript retrieved on 11.06.2015
      String.prototype.replaceAt=function(index, character) {
          return this.substr(0, index) + character + this.substr(index+character.length);
      }


 
      function ItemMarker(id, title, program, date, locationChar, latitude, longitude, link, description, locationMarker) {
        this.id = id,
        this.title = title;
        this.date = date;
        this.locationChr = locationChar;
        this.locationLat = latitude;
        this.locationLong = longitude;
        this.link = link;
        this.description = description;
        this.distance = distance(locationMarker[0],
                                 locationMarker[1],
                                 latitude,
                                 longitude);
        this.list =  this.title + ' ' + this.distance.toString() + ' km' ;
        if (program != null) {
          this.program = program;
        } else {
          this.program = 'NPO Journalstiek'
        }
        
      }

      // Math.round(this.distance * 100) * 0.01

    // Slightly modified distance function from 
    // http://www.geodatasource.com/developers/javascript retrieved on 08.06.2015
    function distance(lat1, lon1, lat2, lon2) {
      var radlat1 = Math.PI * lat1 / 180
      var radlat2 = Math.PI * lat2 / 180
      var radlon1 = Math.PI * lon1 / 180
      var radlon2 = Math.PI * lon2 / 180
      var theta = lon1 - lon2
      var radtheta = Math.PI * theta/180
      var dist = Math.sin(radlat1) 
                 * Math.sin(radlat2) 
                 + Math.cos(radlat1) 
                 * Math.cos(radlat2) 
                 * Math.cos(radtheta);
      dist = Math.acos(dist)
      dist = dist * 180/Math.PI
      dist = dist * 60 * 1.1515
      // Distance in kilometers
      dist = dist * 1.609344
      dist = Math.round(dist * 100) * 0.01
      return dist
    }
    var parseDate = d3.time.format("%Y-%m-%d %X").parse
    var transDate = d3.time.format("%d-%m-%Y")

    function expand(d) {
      if(d3.select(this).select("ul").empty()) {
      d3.select(this)
         // .on("click", null)
        .append("ul")
        .selectAll("li")
          .data(d.link)
        .enter().append("li")
          .text(function(d) { return d; });
      } else {
        d3.select(this).select("ul").remove()
      }
    }





    

    </script>

    <input id="pac-input" class="controls" type="text" placeholder="Search Box">
    <div id="map-canvas"></div>

    <div id="pagetitle" class="intro"> 
      NPO Geo Finder
    </div>
    <div id="introtext" class="intro"> 
      Please enter a location to find NPO Journalistiek items (full episodes or video fragments) associated with the location.
    </div>

    <div id="episodelist">
    </div>

  </body>
</html>

