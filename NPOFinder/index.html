<!doctype html>
<!--
name:           Jonathan Klaiber
student nr:     10004077
Programmeer Project Juni 2015
-->
<html lang="en" xml:lang="en">
  <head>
      <title>NPO Geo Finder</title>
      <link rel="stylesheet" type="text/css" href="finder.css"/>
      <link rel="stylesheet" type="text/css" href="mb.slider.css"/>
      <link rel="stylesheet" type="text/css" href="episodelist.css"/>
      <link rel="stylesheet" type="text/css" href="filter.css"/>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

  </head>
  <body>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places"></script>
    <script src="d3.js"></script>
    <script src="episodelist.js"></script>
    <script src="datetransformation.js"></script>
    <script src="marker.js"></script>
    <script src="filter.js"></script>
    <script src="resultbar.js"></script>
    <script>
      // Constants
      var resp = null;
      var markers = [];
      var listArray = [];
      var markerArray = [];
      var programArray = ['avro', 'bnn', 'kro', 'kro-ncrv',
                          'max', 'ncrv', 'nos', 'tros',
                          'vara', 'vpro', 'ntr', 'eo']


      function initialize() {

        // Constants
        var boundsScaling = 0.00028;

        LoadFilter()

        // var markers = [];
        var map = new google.maps.Map(document.getElementById('map-canvas'), {
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });


        var defaultBounds = new google.maps.LatLngBounds(
            new google.maps.LatLng(51.5, 5),
            new google.maps.LatLng(53.5, 7));
        map.fitBounds(defaultBounds);



        // Create the search box and link it to the UI element.
        var input = /** @type {HTMLInputElement} */(
            document.getElementById('pac-input'));
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

        var searchBox = new google.maps.places.SearchBox(
          /** @type {HTMLInputElement} */(input));

        // [START region_getplaces]
        // Listen for the event fired when the user selects an item from the
        // pick list. Retrieve the matching places for that item.
        google.maps.event.addListener(searchBox, 'places_changed', function() {
          
          // Removes all current markers
          deleteMarkers()

          // Removes current list
          if(!d3.select("#episodelist").select("ul").empty()) {
            d3.select("#episodelist").select("ul").remove()
          }
          
          var places = searchBox.getPlaces();

          if (places.length == 0) {
            return;
          }

          // Getting data for the search marker
          var bounds = new google.maps.LatLngBounds();
          for (var i = 0, place; place = places[i]; i++) {
            var image = {
              url: place.icon,
              size: new google.maps.Size(71, 71),
              origin: new google.maps.Point(0, 0),
              anchor: new google.maps.Point(17, 34),
              scaledSize: new google.maps.Size(25, 25)
            };

            // Placing the search marker
            var marker = new google.maps.Marker({
              map: map,
              icon: image,
              title: place.name,
              position: place.geometry.location
            });
            markers.push(marker);


            bounds.extend(place.geometry.location);
       
            bounds.za.A = bounds.za.A * (1 + boundsScaling);
            bounds.za.j = bounds.za.j * (1 - boundsScaling);
            bounds.qa.A = bounds.qa.A * (1 + boundsScaling);
            bounds.qa.j = bounds.qa.j * (1 - boundsScaling);

            var req = createRequest();


            url1 = 'http://backstage-api.openstate.eu/v0/search'
            url2 = "http://backstage-api.openstate.eu/v0/sources"
            url3 = 'http://backstage-api.openstate.eu/v0/journalistiek/search'
            url4 = 'http://backstage-api.openstate.eu/v0/npo_journalistiek/journalistiek_Oben_290_37227'


            var markerGeo = place.geometry.location;
            var markerName = place.name;


            
            // Create the callback:
            req.onreadystatechange = function() {
              if (req.readyState != 4) return; // Not there yet
              if (req.status != 200) {
                // Handle request failure here...
                return;
              }
              // Request successful, read the response
              resp = req.responseText;
              // ... and use it as needed by your app

              // console.log('resp')
              // console.log(resp)
              var obj = JSON.parse(resp);
              var hits = obj.hits.hits

              // parseDate(hits[i]._source.Date.substring(0,hits[i]._source.Date.indexOf("T")))

              console.log("Number hits")
              console.log(hits.length)
              console.log("Hit")
              console.log(hits[0])
              var program = null;
              listArray = [];
              markerArray = [];
              for (var i = 0; i < hits.length; i++) {

                if(hits[i]._source.Broadcasters != null) {
                    program = hits[i]._source.Broadcasters[0].Name
                }
                // console.log('Hit')
                // console.log(hits[i]._source)

                
                if(hits[i]._source.Locations != null) {

                  var item = new ItemMarker(hits[i]._source.Id,
                                            hits[i]._source.Title,
                                            program,
                                            parseDate(hits[i]._source.Date.replaceAt(10,' ')),
                                            hits[i]._source.Locations[0].Name,
                                            hits[i]._source.Locations[0].GeoPoint.Latitude,
                                            hits[i]._source.Locations[0].GeoPoint.Longitude,
                                            hits[i]._source.Url, 
                                            hits[i]._source.description,
                                            [markerGeo.A, markerGeo.F])
                   markerArray.push(item);


                } else {
                  var item = new ItemMarker(hits[i]._source.Id,
                                            hits[i]._source.Title,
                                            program,
                                            parseDate(hits[i]._source.Date.replaceAt(10,' ')),
                                            markerName,
                                            null,
                                            null,
                                            hits[i]._source.Url, 
                                            hits[i]._source.description,
                                            [markerGeo.A, markerGeo.F])
                  listArray.push(item)
                }
              }

              console.log('markerArray')
              console.log(markerArray)

              // Placing NPO item markers on map
              if (markerArray.length > 1) {
                for (var i = 0; i < markerArray.length; i++) {
                  placeMarker(map, markerArray[i])
                }
              }


              DisplayResultBar(markerName, markerArray, listArray)
              LoadEpisodelist()

            }

            req.onreadystatechange()


            // var arguments = '{"query": "ajax","facets": {"collection": {},"date": {"interval": "day"}},"filters": {"media_content_type": {"terms": ["image/jpeg"]}},"size": 1}';
            // , "filters": {"media_content_type": {"terms": ['video/avi', 'video/mpeg', 'video/quicktime']}}
            // , "sort": "date"

            arguments = '{"query": "' + place.name + '", "filters":{"date": {"from": "'+ queryDate(from) +'", "to": "' + queryDate(to) + '"}}, "size": 100, "sort": "date"}';
            // req.open("GET", url2, true);
            // req.send();

            // arguments = '{"query": "' + place.name + '", "size": 100, "sort": "date"}';
            query = 'POST'

            if (query == 'GET') {
              req.open("GET", url4, true);
              req.send();
            } else {
              req.open("POST", url3, true);
              req.setRequestHeader("Content-Type",
                         "application/x-www-form-urlencoded");
              req.send(arguments);
            }



          }
          map.fitBounds(bounds);
        });
        // [END region_getplaces]

        // Bias the SearchBox results towards places that are within the bounds of the
        // current map's viewport.
         // defined above
        google.maps.event.addListener(map, 'bounds_changed', function() {
          var bounds = map.getBounds();
          searchBox.setBounds(bounds);
        });
      }

      google.maps.event.addDomListener(window, 'load', initialize);



      function createRequest() {
        var result = null;
        if (window.XMLHttpRequest) {
          // FireFox, Safari, etc.
          result = new XMLHttpRequest();
          if (typeof result.overrideMimeType != 'undefined') {
            result.overrideMimeType('text/xml'); // Or anything else
          }
        }
        else if (window.ActiveXObject) {
          // MSIE
          result = new ActiveXObject("Microsoft.XMLHTTP");
        } 
        else {
          // No known mechanism -- consider aborting the application
        }
        return result;
      }



    </script>

    <input id="pac-input" class="controls" type="text" placeholder="Search Box">
    <div id="map-canvas"></div>

    <div id="pagetitle" class="intro"> 
      NPO Geo Finder
    </div>

    <div id="introtext" class="intro"> 
      Please enter a location to find NPO Journalistiek items (full episodes or video fragments) associated with the location.
    </div>

    <div id="filterdiv" class="intro"> 
      <div id = 'arrowdiv'>
        <div id = "arrow-right" class="arrow"></div>
      </div>
      <div id = 'filtertext'> Filter </div>
    </div>
<!--    <div id = 'filtertoggle' class = 'intro'>
      <div class = "programfilter">
      </div>
    </div> -->

 

    <div id="episodelist"></div>
    <div id = "results" class = 'intro'></div>

  </body>
</html>


